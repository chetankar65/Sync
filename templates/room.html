<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://www.youtube.com/iframe_api"></script>
    <title>Sync | Watch videos, movies and listen to songs with your friends</title>
    <style>
        #username,
        #roomCode,
        #message,
        #displayName {
            background-position: 10px 12px;
            background-repeat: no-repeat;
            width: 50%;
            font-size: 16px;
            padding: 12px 20px 12px 40px;
            border: 1px solid #ddd;
            margin-bottom: 12px;
        }

        .submit {
            background-color: blue;
            border: none;
            color: white;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            width: 50%;
        }

        #message_box {
            background-color: cyan;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
        }

        #progress-bar {
            position: relative;
            width: 100%;
            height: 20px;
            cursor: pointer;
        }

        #controls i {
            color: #000;
            font-size: 32px;
            cursor: pointer;
        }

        #volume-input {
            height: 32px;
            width: 45px;
        }

        #messages {
            bottom: 0;
        }
    </style>
</head>

<body>
    <audio id="message_audio">
        <source src="/static/notification.mp3" type="audio/mpeg">
    </audio>
    <div class='row'>
        <div class="col-lg-8">
            <h3>Room ID : {{room}}</h3>
            <div id="video-placeholder" style="width:100%;height:500px;"></div>
            <div class="jumbotron" id="controls">
                {% if control_bool %}
                    <p>Use these controls to sync with your partner.</p><br>
                    <p><span id="current-time">0:00</span> / <span id="duration">0:00</span></p>
                    <input type="range" id="progress-bar" value="0" style="width:100%;"><br>
                    <i id="play" class="material-icons">play_arrow</i>
                    <i id="pause" class="material-icons">pause</i>
                    <i idl="mute-toggle" class="material-icons">volume_up</i><br>
                    <div class="row">
                        <div class="col-sm-6 col-lg-6 col-6 col-md-6">
                            <p>Speed</p>
                            <select id="speed">
                                <option>0.25</option>
                                <option>0.5</option>
                                <option selected="selected">1</option>
                                <option>1.5</option>
                                <option>2</option>
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-6 col-6 col-md-6">
                            <p>Quality</p>
                            <select id="quality">
                                <option>small</option>
                                <option>medium</option>
                                <option selected="selected">large</option>
                                <option>hd720</option>
                                <option>hd1080</option>
                                <option>highres</option>
                            </select>
                        </div>
                    </div>
                {% else %}
                    <div class="row">
                        <h3>Only the creator of the room can control the video!</h3>
                    </div>
                {% endif %}
            </div>
        </div>
        <br><br>
        <div class="col-lg-4">
            <button class='btn btn-danger' onclick="exit()">Exit room</button><br><br>
            <h3>Chat :</h3>
            <hr>
            <div id="messages" style="height:400px;overflow:scroll;" align='left'>
            </div>
            <br>
            <input type="text" id="message" style="width:100%;padding:20px;" placeholder="Message...">
            <button style="padding: 12px 20px 12px;width:100%;" class="submit" onclick="send_message()"
                id="send_btn">Send message</button>
            <br>
        </div>
    </div>
    <script>
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port)
    var audio = document.getElementById("message_audio")
    var code = "{{ room | safe }}"
    document.addEventListener('DOMContentLoaded', () => {
        /// Playing the audio
        function playAudio() 
        {
            audio.play();
        }
        // Pausing the audio
        function pauseAudio() 
        {
            audio.pause();
        }
        // Load all the messages
        function loadAllMessages(code)
        {
            socket.emit('get messages', {'code': code});
        }
        // Send message
        socket.on('connect', () => 
        {
            socket.emit('join', {'code': code})
            loadAllMessages(code)
            return false;
        })
        /// give alert if someone left
        socket.on('left', function (json) 
        {
            swal(json.greet)
            playAudio()
        })
        // Enter button
        var input = document.getElementById('message')
        input.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("send_btn").click();
            }
        });
        // Scroll to the bottom of the messages division
        function scrollToBottom(id) 
        {
            var div = document.getElementById(id);
            div.scrollTop = div.scrollHeight - div.clientHeight;
        }
        // get all the messages
        socket.on('allmessages', function (json) 
        {
            var content = ''
            for (var i = 0; i < json.messages.length; i++)
            {
                content += 
                `<div id="message_box">
                    <b>${json.messages[i].username}
                    </b><br><br>
                    ${json.messages[i].message}
                </div><br>
                `
            }
            document.querySelector('#messages').innerHTML = content
            scrollToBottom("messages")
            playAudio()
        })
        // Initialise the variables
        var player, time_update_interval = 0
        // on youtube iframe api ready
        function onYouTubeIframeAPIReady(video) 
        {
            console.log(video)
            var video_id = video
            player = new YT.Player('video-placeholder', {
                width: 600,
                height: 400,
                videoId: video_id,
                playerVars: {
                    color: 'white',
                    controls: 0,
                    autoplay: 0,
                    loop: 0
                },
                events: {
                    onReady: initialize 
                }
            });
        }
        // Initialise video 
        function initialize() 
        {
            // Update the controls on load
            updateTimerDisplay();
            updateProgressBar();
            // Clear any old interval.
            clearInterval(time_update_interval);
            // Start interval to update elapsed time display and
            // the elapsed part of the progress bar every second.
            time_update_interval = setInterval(function () {
                updateTimerDisplay();
                updateProgressBar();
            }, 1000);
            // $('#volume-input').val(Math.round(player.getVolume()));
        }
        // This function is called by initialize()
        function updateTimerDisplay() 
        {
            // Update current time text display.
            $('#current-time').text(formatTime(player.getCurrentTime()));
            $('#duration').text(formatTime(player.getDuration()));
            /// controllers
        }
        // This function is called by initialize()
        function updateProgressBar() 
        {
            // Update the value of our progress bar accordingly.
            $('#progress-bar').val((player.getCurrentTime() / player.getDuration()) * 100);
        }
        // Progress bar
        jQuery(document.body).on('mouseup touchend', '#progress-bar', function (event) 
        {
            // Calculate the new time for the video.
            // new time in seconds = total duration in seconds * ( value of range input / 100 )
            var newTime = player.getDuration() * (event.target.value / 100);
            // Skip video to new time.
            socket.emit('control_time', {'newtime': newTime, 'code': code})
        });
        // play video
        jQuery(document.body).on('click', '#play', function (event) 
        {
            var control = true
            socket.emit('control_video', {'control': control, 'code': code})
        });
        // pause Video
        jQuery(document.body).on('click', ' #pause', function (event) 
        {
            var control = false
            socket.emit('control_video', {'control': control, 'code': code})
        });
        // Sound volume
        jQuery(document.body).on('click', '#mute-toggle', function (event) 
        {
            var mute_toggle = $(this);
            if (player.isMuted()) {
                player.unMute();
                mute_toggle.text('volume_up');
            }
            else {
                player.mute();
                mute_toggle.text('volume_off');
            }
        });
        // speed of the video
        jQuery(document.body).on('change', '#speed', function (event) 
        {
            socket.emit('control_speed', {'speed': speed, 'code': code})
        });
        // quality of the video
        jQuery(document.body).on('change', '#quality', function (event) 
        {
            player.setPlaybackQuality($(this).val());
        });
        // Time
        function formatTime(time) 
        {
            time = Math.round(time);

            var minutes = Math.floor(time / 60),
                seconds = time - minutes * 60;

            seconds = seconds < 10 ? '0' + seconds : seconds;

            return minutes + ":" + seconds;
        }
        // All rooms
        socket.on('allRooms', function (json) 
        {
            swal(json.greet, { button: false })
            var video = json.link
            playAudio()
            onYouTubeIframeAPIReady(video)
        })
        // Get the time at which the video loads
        socket.on('time', function (json) 
        {
            player.seekTo(json.newtime, true)
        })
        // Get the status of the video
        socket.on('status', function (json) 
        {
            if (json.status == true) {
                player.playVideo()
            }
            else {
                player.pauseVideo()
            }
        })
        /*
            Check frequently video state:
         
            -1 - unstarted
            0 - ended
            1 - playing
            2 - paused
            3 - buffering
            5 - video cued
        */
        // Set the playback speed of the video
        socket.on('speed', function (json) 
        {
            player.setPlaybackRate(json.speed);
        })
    })

    // send the message on click or on enter
    function send_message() 
    {
        var message = document.querySelector('#message').value
        if (message.length == 0 && message.trim() == "") {
            return false
        }
        else 
        {
            socket.emit('message', {'code': code, 'message': message})
            document.querySelector('#message').value = ''
        }
    }
    // function redirect
    function redirect() 
    {
        window.location.replace("/")
    }
    // exit the room
    function exit() 
    {
        swal("Leaving...", { button: false })
        socket.emit('leave', {'code': code})
        setTimeout(redirect, 3000)
    }
    </script>
</body>

</html>